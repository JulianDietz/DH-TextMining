{% extends 'index.html' %}

{% block body %}

    {% load static %}
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="{% static "js/corpusSelection/fieldAdder.js" %}"></script>
    <link href='{% static "css/corpusSelection.css" %}' rel="stylesheet">

    <div id="siteContainer">
        <!-- Auswahldropdown für Textarten: Raw,NltkStw,NltkStem-->
        <div>
            <span>Textvariante: </span>
            <select id="textVariante">
            <option value="Raw">Raw</option>
            <option value="NltkStw">NltkStw</option>
            <option value="NltkStem">NltkStem</option>
            </select>
        </div>

        <form id="container" action="{% url 'getSelectedPaper' %}" method="post">
            {% csrf_token %}
            <button id="startAnalysisButton" class="cust_button">verfügbare Paper anzeigen</button>
        </form>
    </div>

    <button id="addCorpusButton">+</button>


    <script>
        overridestartAjaxFilter();

        function overridestartAjaxFilter() {
            $('#container').submit(function (event) {
                event.preventDefault();
                $('#addCorpusButton').hide();
                $.ajax({
                    url: $('#container').attr('action'),
                    type: $('#container').attr('method'),
                    data: $('#container').serialize(),
                    success: function (response) {
                        changeButton();
                        showResponse(response)
                    }
                });
                return false;

            });
        }

        function showResponse(response) {
            console.log(response);
            if (response.corpus1) {
                let target = document.getElementById('corpus_1');
                table = createPaperTable(JSON.parse(response.corpus1), 'Korpus1');
                target.insertAdjacentHTML('beforeend', table);
            }
            if (response.corpus2) {
                let target = document.getElementById('corpus_2');
                table = createPaperTable(JSON.parse(response.corpus2), 'Korpus2');
                target.insertAdjacentHTML('beforeend', table);
            }
        }

        function createPaperTable(papers, korpusid) {
            htmldata = '<h4>' + korpusid + '</h4><table id="datatable-' + korpusid + '" class="searchDataSelector table table-bordered">' +
                '<thead><tr><th>Ausgewählt</th><th>Titel</th><th>Autoren</th>' +
                '</tr></thead><tbody>';
            for (let paper of papers) {
                htmldata += '<tr><td><input type="checkbox" name="' + korpusid + '" value="' + paper._id.$oid + '"/></td>' +
                    '<td>' + paper.titleRaw.text + '</td><td>';
                for (let i = 0; i < paper.authors.length; i++) {
                    let autor = paper.authors[i];
                    if (i !== paper.authors.length - 1) {
                        htmldata += autor.name + ' ,'
                    } else {
                        htmldata += autor.name
                    }
                }
                htmldata += '</td></tr>';
            }
            return htmldata
        }

        function changeButton() {
            $("#startAnalysisButton").attr('type', 'button').text('Analyse starten').click(function () {
                sendPaperlist();
            });
        }

        function sendPaperlist() {
            //console.log('send paperlist');
            let korpus1data = [];
            $.each($("input[name='Korpus1']:checked"), function () {
                korpus1data.push($(this).val());
            });
            let korpus2data = [];
            $.each($("input[name='Korpus2']:checked"), function () {
                korpus2data.push($(this).val());
            });
            //window.location = '{% url 'startAnalyse' %}?Korpus1=' + korpus1data + '&Korpus2=' + korpus2data;

            let variante=$('#textVariante').val();
            let form = '<form id="postform" action="{% url 'startAnalyse' %}" method="POST">' +
                '{% csrf_token %}';
            for (paperid of korpus1data) {
                form += '<input type="hidden" name="Korpus1" value="' + paperid + '">'
            }
            for (paperid of korpus2data) {
                form += '<input type="hidden" name="Korpus2" value="' + paperid + '">'
            }
            form += '<input type="hidden" name="textVariante" value="' + variante + '">';
            form += '</form>';
            let target = document.getElementById('siteContainer');
            target.insertAdjacentHTML('afterEnd', form);
            $('#postform').submit();
        }
    </script>
{% endblock %}